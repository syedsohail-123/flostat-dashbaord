var k=Object.defineProperty;var C=(n,t,s)=>t in n?k(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s;var z=(n,t,s)=>C(n,typeof t!="symbol"?t+"":t,s);const I=n=>new TextEncoder().encode(n),B=n=>{if(typeof n=="string")return n;if(typeof n!="object"||typeof n.byteOffset!="number"||typeof n.byteLength!="number")throw new Error("@smithy/util-utf8: toUtf8 encoder function only accepts string | Uint8Array.");return new TextDecoder("utf-8").decode(n)};class O{constructor({marshaller:t,serializer:s,deserializer:c,serdeContext:m,defaultContentType:y}){z(this,"marshaller");z(this,"serializer");z(this,"deserializer");z(this,"serdeContext");z(this,"defaultContentType");this.marshaller=t,this.serializer=s,this.deserializer=c,this.serdeContext=m,this.defaultContentType=y}async serializeEventStream({eventStream:t,requestSchema:s,initialRequest:c}){const m=this.marshaller,y=s.getEventStreamMember(),S=s.getMemberSchema(y),d=this.serializer,u=this.defaultContentType,h=Symbol("initialRequestMarker"),b={async*[Symbol.asyncIterator](){if(c){const a={":event-type":{type:"string",value:"initial-request"},":message-type":{type:"string",value:"event"},":content-type":{type:"string",value:u}};d.write(s,c);const f=d.flush();yield{[h]:!0,headers:a,body:f}}for await(const a of t)yield a}};return m.serialize(b,a=>{if(a[h])return{headers:a.headers,body:a.body};const f=Object.keys(a).find(o=>o!=="__type")??"",{additionalHeaders:r,body:e,eventType:i,explicitPayloadContentType:v}=this.writeEventBody(f,S,a);return{headers:{":event-type":{type:"string",value:i},":message-type":{type:"string",value:"event"},":content-type":{type:"string",value:v??u},...r},body:e}})}async deserializeEventStream({response:t,responseSchema:s,initialResponseContainer:c}){var f;const m=this.marshaller,y=s.getEventStreamMember(),d=s.getMemberSchema(y).getMemberSchemas(),u=Symbol("initialResponseMarker"),h=m.deserialize(t.body,async r=>{var v,x;const e=Object.keys(r).find(o=>o!=="__type")??"",i=r[e].body;if(e==="initial-response"){const o=await this.deserializer.read(s,i);return delete o[y],{[u]:!0,...o}}else if(e in d){const o=d[e];if(o.isStructSchema()){const l={};let T=!1;for(const[p,w]of o.structIterator()){const{eventHeader:E,eventPayload:M}=w.getMergedTraits();if(T=T||!!(E||M),M)w.isBlobSchema()?l[p]=i:w.isStringSchema()?l[p]=(((v=this.serdeContext)==null?void 0:v.utf8Encoder)??B)(i):w.isStructSchema()&&(l[p]=await this.deserializer.read(w,i));else if(E){const g=(x=r[e].headers[p])==null?void 0:x.value;g!=null&&(w.isNumericSchema()?g&&typeof g=="object"&&"bytes"in g?l[p]=BigInt(g.toString()):l[p]=Number(g):l[p]=g)}}if(T)return{[e]:l}}return{[e]:await this.deserializer.read(o,i)}}else return{$unknown:r}}),b=h[Symbol.asyncIterator](),a=await b.next();if(a.done)return h;if((f=a.value)!=null&&f[u]){if(!s)throw new Error("@smithy::core/protocols - initial-response event encountered in event stream but no response schema given.");for(const[r,e]of Object.entries(a.value))c[r]=e}return{async*[Symbol.asyncIterator](){var r;for((r=a==null?void 0:a.value)!=null&&r[u]||(yield a.value);;){const{done:e,value:i}=await b.next();if(e)break;yield i}}}}writeEventBody(t,s,c){var f;const m=this.serializer;let y=t,S=null,d;const u=s.getSchema()[4].includes(t),h={};if(u){const r=s.getMemberSchema(t);if(r.isStructSchema()){for(const[e,i]of r.structIterator()){const{eventHeader:v,eventPayload:x}=i.getMergedTraits();if(x){S=e;break}else if(v){const o=c[t][e];let l="binary";i.isNumericSchema()?(-2)**31<=o&&o<=2**31-1?l="integer":l="long":i.isTimestampSchema()?l="timestamp":i.isStringSchema()?l="string":i.isBooleanSchema()&&(l="boolean"),o!=null&&(h[e]={type:l,value:o},delete c[t][e])}}if(S!==null){const e=r.getMemberSchema(S);e.isBlobSchema()?d="application/octet-stream":e.isStringSchema()&&(d="text/plain"),m.write(e,c[t][S])}else m.write(r,c[t])}else throw new Error("@smithy/core/event-streams - non-struct member not supported in event stream union.")}else{const[r,e]=c[t];y=r,m.write(15,e)}const b=m.flush();return{body:typeof b=="string"?(((f=this.serdeContext)==null?void 0:f.utf8Decoder)??I)(b):b,eventType:y,explicitPayloadContentType:d,additionalHeaders:h}}}export{O as EventStreamSerde};
